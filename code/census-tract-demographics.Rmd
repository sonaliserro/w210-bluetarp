---
title: 'Census Tract Demographics - Florida, Puerto Rico, Texas'
subtitle: 'Census Demographic Master Script'
author: 'Ross MacLean'
geometry: margin=1in
output:
  github_document: default
  pdf_document: default
  toc: yes
  number_sections: yes
fontsize: 11pt
knit: (function(inputFile, encoding) {
  rmarkdown::render(
    inputFile, encoding = encoding,
    output_format = c('github_document', 'pdf_document'))
    })
---

```{r}
# Load packages
library(car)
library(dplyr)
library(tidyr)
library(data.table)
library(ggplot2)
library(ggcorrplot)
library(gridExtra)
library(GGally)
library(knitr)
```

# Combine Files for Master Block Group Base

```{r}
# Function which read in data and cleans the file for stacking
tidy_data <- function(file){
  
  # Read data
  d <- fread(file = file, encoding = 'UTF-8', skip = 1)

  # Select census block group id and name
  d <- d[ ,c(1,2)]
  
  setnames(d, old = c('id', 'Geographic Area Name'), new = c('censusid', 'tractname'))
  
  return(d)
  }
```


```{r}
# Identify all census files
filenames <- list.files('../data/census-tract/raw/', pattern='*.csv', full.names=TRUE)

d_full <- tidy_data(filenames[1])

# Loop through all files except first
for (file in tail(filenames, -1)) {
  
  # Read data and stack
  d_measure <- tidy_data(file = file)
  d_full <- rbind(d_full, d_measure)
}

# Census Tract ID
d_full[ , `:=` (tractid = substr(censusid, 10, 22))]

# Full list of all census block group
d_full <- d_full[ , .(count = .N), keyby = c('censusid', 'tractid', 'tractname')][ , -c('count')]

head(d_full)
print(filenames)
```

# Join Individual Measures to Blocks

```{r}
# Function which read in data and cleans for joining
read_data <- function(file){
  
  # Read data and rename
  d <- fread(file = file, encoding = 'UTF-8', skip = 1)
  setnames(d, old = c('id', 'Geographic Area Name'), new = c('censusid', 'tractname'))
  
  # Replace redacted values with NA
  d[d == '**'] <- NA      # margin - no sample observations or too few sample observations were available.  Stats test not good
  d[d == '-'] <- NA       # estimate - no sample observations or too few sample observations were available.  
  d[d == '***'] <- NA     # margin - median falls in the lowest interval or upper interval of an open-ended distribution.  Stats test not good.
  d[d == '*****'] <- NA   # margin - the estimate is controlled. A statistical test for sampling variability is not appropriate.
  d[d == 'N'] <- NA       # both - data for this geographic area cannot be displayed because the number of sample cases is too small.
  d[d == '(X)'] <- NA     # estimate - not applicable or not available.

  # Extreme estimates converted NAs later in script (median earnings/median value)
  # median estimate - the median falls in the lowest interval of an open-ended distribution.
  # median estimate - the median falls in the upper interval of an open-ended distribution.

  return(d)
  }
```


## Populations

```{r}
# Read data
d_population <-read_data(file = '../data/census-tract/raw/population.csv')
d_population

# Rename fields
setnames(d_population, old = c('Estimate!!Total!!Total population',
                               'Estimate!!Male!!Total population',
                               'Estimate!!Female!!Total population'),
                       new = c('total_population',
                               'male_population',
                               'female_population'))

# Keep required fields
d_population <- d_population[ , c('censusid', 'total_population', 'male_population', 'female_population')]

# Left join to full data
d_full <- merge(x = d_full, y = d_population, by = 'censusid', all.x = TRUE)
head(d_full)
```

## Educational Attainment (25-yrs plus)

```{r}
# Read data
d_education <-read_data(file = '../data/census-tract/raw/educational-attainment.csv')
d_education

# Rename fields
setnames(d_education, old = c('Estimate!!Total!!Population 25 years and over',
                              'Estimate!!Total!!Population 25 years and over!!High school graduate (includes equivalency)',
                              "Estimate!!Total!!Population 25 years and over!!Bachelor's degree",
                              'Estimate!!Total!!Population 25 years and over!!Graduate or professional degree',
                              "Estimate!!Percent!!Population 25 years and over!!Percent bachelor's degree or higher"),
                      new = c('total_population_edu',
                              'high_school_grad',
                              'bachelors_degree',
                              'graduate_prof_degree',
                              'bachelors_plus_degree_rate'))

# Keep required fields
d_education <- d_education[ , c('censusid', 'total_population_edu', 'high_school_grad', 'bachelors_degree',
                                'graduate_prof_degree')]

# Calculate rates
d_education[ , `:=` (high_school_grad_rate = high_school_grad/total_population_edu,
                     bachelors_degree_rate = bachelors_degree/total_population_edu,
                     graduate_prof_degree_rate = graduate_prof_degree/total_population_edu,
                     bachelors_plus_degree_rate = (bachelors_degree + graduate_prof_degree)/total_population_edu)]

# Left join to full data
d_full <- merge(x = d_full, y = d_education, by = 'censusid', all.x = TRUE)
head(d_full)
```

## Employment Status

```{r}
# Read data
d_employment <-read_data(file = '../data/census-tract/raw/employment-status.csv')
d_employment

# Rename fields
setnames(d_employment, old = c('Estimate!!Total',
                               'Estimate!!Total!!In labor force',
                               'Estimate!!Total!!In labor force!!Civilian labor force',
                               'Estimate!!Total!!In labor force!!Civilian labor force!!Employed',
                               'Estimate!!Total!!In labor force!!Civilian labor force!!Unemployed',
                               'Estimate!!Total!!In labor force!!Armed Forces',
                               'Estimate!!Total!!Not in labor force'),
                      new = c('total_population_employ',
                              'labor_force_total',
                              'civilian_labor_force',
                              'employed_labor_force',
                              'unemployed_labor_force',
                              'armed_forces_labor_force',
                              'not_labor_force_total'))

# Keep required fields
d_employment <- d_employment[ , c('censusid', 'total_population_employ', 'labor_force_total', 'civilian_labor_force',
                                  'employed_labor_force', 'unemployed_labor_force', 'armed_forces_labor_force',
                                  'not_labor_force_total')]

# Calculate rates
d_employment[ , `:=` (labor_force_rate = labor_force_total/total_population_employ,
                      civilian_labor_rate = civilian_labor_force/total_population_employ,
                      employed_labor_rate = employed_labor_force/total_population_employ,
                      unemployed_labor_rate = unemployed_labor_force/total_population_employ,
                      armed_forces_labor_rate = armed_forces_labor_force/total_population_employ,
                      not_labor_force_rate = not_labor_force_total/total_population_employ)]

# Left join to full data
d_full <- merge(x = d_full, y = d_employment, by = 'censusid', all.x = TRUE)
head(d_full)
```


## Family Income

```{r}
# Read data
d_income <-read_data(file = '../data/census-tract/raw/family-income.csv')
d_income

# Rename fields
setnames(d_income, old = c('Estimate!!Total',
                           'Estimate!!Total!!Less than $10,000',
                           'Estimate!!Total!!$10,000 to $14,999',
                           'Estimate!!Total!!$15,000 to $19,999',
                           'Estimate!!Total!!$20,000 to $24,999',
                           'Estimate!!Total!!$25,000 to $29,999',
                           'Estimate!!Total!!$30,000 to $34,999',
                           'Estimate!!Total!!$35,000 to $39,999',
                           'Estimate!!Total!!$40,000 to $44,999',
                           'Estimate!!Total!!$45,000 to $49,999',
                           'Estimate!!Total!!$50,000 to $59,999',
                           'Estimate!!Total!!$60,000 to $74,999',
                           'Estimate!!Total!!$75,000 to $99,999',
                           'Estimate!!Total!!$100,000 to $124,999',
                           'Estimate!!Total!!$125,000 to $149,999',
                           'Estimate!!Total!!$150,000 to $199,999',
                           'Estimate!!Total!!$200,000 or more'),
                   new = c('total_population_income',
                           'income_less_10k',
                           'income_10k_15k',
                           'income_15k_20k',
                           'income_20k_25k',
                           'income_25k_30k',
                           'income_30k_35k',
                           'income_35k_40k',
                           'income_40k_45k',
                           'income_45k_50k',
                           'income_50k_60k',
                           'income_60k_75k',
                           'income_75k_100k',
                           'income_100k_125k',
                           'income_125k_150k',
                           'income_150k_200k',
                           'income_200k_more'))

# Keep required fields
d_income <- d_income[ , c('censusid', 'total_population_income', 'income_less_10k', 'income_10k_15k', 'income_15k_20k',
                           'income_20k_25k', 'income_25k_30k', 'income_30k_35k', 'income_35k_40k', 'income_40k_45k',
                           'income_45k_50k', 'income_50k_60k', 'income_60k_75k', 'income_75k_100k', 'income_100k_125k',
                           'income_125k_150k', 'income_150k_200k', 'income_200k_more')]

# Left join to full data
d_full <- merge(x = d_full, y = d_income, by = 'censusid', all.x = TRUE)
head(d_full)
```

## Median Earnings

```{r}
# Read data
d_earnings <- read_data(file = '../data/census-tract/raw/median-earnings.csv')
d_earnings

# Rename fields
setnames(d_earnings, old = c('Estimate!!Median earnings in the past 12 months (in 2017 inflation-adjusted dollars) --!!Total (dollars)',
'Estimate!!Median earnings in the past 12 months (in 2017 inflation-adjusted dollars) --!!Male --!!Total (dollars)',
'Estimate!!Median earnings in the past 12 months (in 2017 inflation-adjusted dollars) --!!Male --!!Worked full-time, year-round in the past 12 months (dollars)',
'Estimate!!Median earnings in the past 12 months (in 2017 inflation-adjusted dollars) --!!Male --!!Other (dollars)',
'Estimate!!Median earnings in the past 12 months (in 2017 inflation-adjusted dollars) --!!Female --!!Total (dollars)',
'Estimate!!Median earnings in the past 12 months (in 2017 inflation-adjusted dollars) --!!Female --!!Worked full-time, year-round in the past 12 months (dollars)',
'Estimate!!Median earnings in the past 12 months (in 2017 inflation-adjusted dollars) --!!Female --!!Other (dollars)'),
                     new = c('median_earnings_total',
                             'median_earnings_male',
                             'median_earnings_male_fulltime',
                             'median_earnings_male_other',
                             'median_earnings_female',
                             'median_earnings_female_fulltime',
                             'median_earnings_female_other'))

# Keep required fields
d_earnings <- d_earnings[ , c('censusid', 'median_earnings_total', 'median_earnings_male', 'median_earnings_male_fulltime',
                             'median_earnings_male_other', 'median_earnings_female',
                             'median_earnings_female_fulltime', 'median_earnings_female_other')]

# Left join to full data
d_full <- merge(x = d_full, y = d_earnings, by = 'censusid', all.x = TRUE)
d_full
```

## Poverty Status

```{r}
# Read data
d_poverty <-read_data(file = '../data/census-tract/raw/poverty-status.csv')
d_poverty

# Rename fields
setnames(d_poverty, old = c('Estimate!!Total',
'Estimate!!Total!!Income in the past 12 months below poverty level',
'Estimate!!Total!!Income in the past 12 months below poverty level!!Family households',
'Estimate!!Total!!Income in the past 12 months below poverty level!!Family households!!Married-couple family',
'Estimate!!Total!!Income in the past 12 months below poverty level!!Family households!!Other family',
'Estimate!!Total!!Income in the past 12 months below poverty level!!Family households!!Other family!!Male householder, no wife present',
'Estimate!!Total!!Income in the past 12 months below poverty level!!Family households!!Other family!!Female householder, no husband present',
'Estimate!!Total!!Income in the past 12 months below poverty level!!Nonfamily households',
'Estimate!!Total!!Income in the past 12 months below poverty level!!Nonfamily households!!Male householder',
'Estimate!!Total!!Income in the past 12 months below poverty level!!Nonfamily households!!Female householder',
'Estimate!!Total!!Income in the past 12 months at or above poverty level',
'Estimate!!Total!!Income in the past 12 months at or above poverty level!!Family households',
'Estimate!!Total!!Income in the past 12 months at or above poverty level!!Family households!!Married-couple family',
'Estimate!!Total!!Income in the past 12 months at or above poverty level!!Family households!!Other family',
'Estimate!!Total!!Income in the past 12 months at or above poverty level!!Family households!!Other family!!Male householder, no wife present',
'Estimate!!Total!!Income in the past 12 months at or above poverty level!!Family households!!Other family!!Female householder, no husband present',
'Estimate!!Total!!Income in the past 12 months at or above poverty level!!Nonfamily households',
'Estimate!!Total!!Income in the past 12 months at or above poverty level!!Nonfamily households!!Male householder',
'Estimate!!Total!!Income in the past 12 months at or above poverty level!!Nonfamily households!!Female householder'),
                    new = c('total_households_poverty',
                            'below_poverty',
                            'below_poverty_family',
                            'below_poverty_family_married',
                            'below_poverty_family_other',
                            'below_poverty_family_other_male_no_spouse',
                            'below_poverty_family_other_female_no_spouse',
                            'below_poverty_nonfamily',
                            'below_poverty_nonfamily_male',
                            'below_poverty_nonfamily_female',
                            'above_poverty',
                            'above_poverty_family',
                            'above_poverty_family_married',
                            'above_poverty_family_other',
                            'above_poverty_family_other_male_no_spouse',
                            'above_poverty_family_other_female_no_spouse',
                            'above_poverty_nonfamily',
                            'above_poverty_nonfamily_male',
                            'above_poverty_nonfamily_female'))

# Keep required fields
d_poverty <- d_poverty[ , c('censusid', 'total_households_poverty', 'below_poverty', 'below_poverty_family',
                            'below_poverty_family_married', 'below_poverty_family_other',
                            'below_poverty_family_other_male_no_spouse', 'below_poverty_family_other_female_no_spouse',
                            'below_poverty_nonfamily', 'below_poverty_nonfamily_male', 'below_poverty_nonfamily_female',
                            'above_poverty', 'above_poverty_family', 'above_poverty_family_married',
                            'above_poverty_family_other', 'above_poverty_family_other_male_no_spouse',
                            'above_poverty_family_other_female_no_spouse', 'above_poverty_nonfamily',
                            'above_poverty_nonfamily_male', 'above_poverty_nonfamily_female')]

# Calculate rates
d_poverty[ , `:=` (below_poverty_rate = below_poverty/total_households_poverty,
                   below_poverty_family_rate = below_poverty_family/total_households_poverty,
                   below_poverty_family_married_rate = below_poverty_family_married/total_households_poverty,
                   below_poverty_family_other_rate = below_poverty_family_other/total_households_poverty,
                   below_poverty_family_other_male_no_spouse_rate = below_poverty_family_other_male_no_spouse/total_households_poverty,
                   below_poverty_family_other_female_no_spouse_rate = below_poverty_family_other_female_no_spouse/total_households_poverty,
                   below_poverty_nonfamily_rate = below_poverty_nonfamily/total_households_poverty,
                   below_poverty_nonfamily_male_rate = below_poverty_nonfamily_male/total_households_poverty,
                   below_poverty_nonfamily_female_rate = below_poverty_nonfamily_female/total_households_poverty,
                   above_poverty_rate = above_poverty/total_households_poverty,
                   above_poverty_family_rate = above_poverty_family/total_households_poverty,
                   above_poverty_family_married_rate = above_poverty_family_married/total_households_poverty,
                   above_poverty_family_other_rate = above_poverty_family_other/total_households_poverty,
                   above_poverty_family_other_male_no_spouse_rate = above_poverty_family_other_male_no_spouse/total_households_poverty,
                   above_poverty_family_other_female_no_spouse_rate = above_poverty_family_other_female_no_spouse/total_households_poverty,
                   above_poverty_nonfamily_rate = above_poverty_nonfamily/total_households_poverty,
                   above_poverty_nonfamily_male_rate = above_poverty_nonfamily_male/total_households_poverty,
                   above_poverty_nonfamily_female_rate = above_poverty_nonfamily_female/total_households_poverty)]

# Left join to full data
d_full <- merge(x = d_full, y = d_poverty, by = 'censusid', all.x = TRUE)
head(d_full)
```

## Public Assistance Income or Food Stamps

```{r}
# Read data
d_assistance <-read_data(file = '../data/census-tract/raw/public-assistance.csv')
d_assistance

# Rename fields
setnames(d_assistance, old = c('Estimate!!Total',
                               'Estimate!!Total!!With cash public assistance or Food Stamps/SNAP',
                               'Estimate!!Total!!No cash public assistance or Food Stamps/SNAP'),
                       new = c('total_population_assist',
                               'with_assistance',
                               'without_assistance'))

# Keep required fields
d_assistance <- d_assistance[ , c('censusid', 'total_population_assist', 'with_assistance', 'without_assistance')]


# Calculate rates
d_assistance[ , `:=` (with_assistance_rate = with_assistance/total_population_assist,
                      without_assistance_rate = without_assistance/total_population_assist)]

# Left join to full data
d_full <- merge(x = d_full, y = d_assistance, by = 'censusid', all.x = TRUE)
head(d_full)
```

## Housing Units

```{r}
# Read data
d_housing <- read_data(file = '../data/census-tract/raw/housing-characteristics.csv')
d_housing

# Rename fields
setnames(d_housing, old = c('Estimate!!HOUSING OCCUPANCY!!Total housing units',
'Percent Estimate!!HOUSING OCCUPANCY!!Total housing units',
'Estimate!!HOUSING OCCUPANCY!!Total housing units!!Occupied housing units',
'Percent Estimate!!HOUSING OCCUPANCY!!Total housing units!!Occupied housing units',
'Estimate!!HOUSING OCCUPANCY!!Total housing units!!Vacant housing units',
'Percent Estimate!!HOUSING OCCUPANCY!!Total housing units!!Vacant housing units',
'Estimate!!HOUSING OCCUPANCY!!Total housing units!!Homeowner vacancy rate',
'Percent Estimate!!HOUSING OCCUPANCY!!Total housing units!!Homeowner vacancy rate',
'Estimate!!HOUSING OCCUPANCY!!Total housing units!!Rental vacancy rate',
'Percent Estimate!!HOUSING OCCUPANCY!!Total housing units!!Rental vacancy rate',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 2014 or later',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 2014 or later',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 2010 to 2013',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 2010 to 2013',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 2000 to 2009',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 2000 to 2009',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1990 to 1999',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1990 to 1999',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1980 to 1989',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1980 to 1989',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1970 to 1979',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1970 to 1979',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1960 to 1969',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1960 to 1969',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1950 to 1959',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1950 to 1959',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1940 to 1949',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1940 to 1949',
'Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1939 or earlier',
'Percent Estimate!!YEAR STRUCTURE BUILT!!Total housing units!!Built 1939 or earlier',
'Estimate!!HOUSING TENURE!!Occupied housing units',
'Percent Estimate!!HOUSING TENURE!!Occupied housing units',
'Estimate!!HOUSING TENURE!!Occupied housing units!!Owner-occupied',
'Percent Estimate!!HOUSING TENURE!!Occupied housing units!!Owner-occupied',
'Estimate!!HOUSING TENURE!!Occupied housing units!!Renter-occupied',
'Percent Estimate!!HOUSING TENURE!!Occupied housing units!!Renter-occupied',
'Estimate!!HOUSING TENURE!!Occupied housing units!!Average household size of owner-occupied unit',
'Percent Estimate!!HOUSING TENURE!!Occupied housing units!!Average household size of owner-occupied unit',
'Estimate!!HOUSING TENURE!!Occupied housing units!!Average household size of renter-occupied unit',
'Percent Estimate!!HOUSING TENURE!!Occupied housing units!!Average household size of renter-occupied unit',
'Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units',
'Percent Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units',
'Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 2015 or later',
'Percent Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 2015 or later',
'Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 2010 to 2014',
'Percent Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 2010 to 2014',
'Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 2000 to 2009',
'Percent Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 2000 to 2009',
'Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 1990 to 1999',
'Percent Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 1990 to 1999',
'Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 1980 to 1989',
'Percent Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 1980 to 1989',
'Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 1979 and earlier',
'Percent Estimate!!YEAR HOUSEHOLDER MOVED INTO UNIT!!Occupied housing units!!Moved in 1979 and earlier',
'Estimate!!SELECTED CHARACTERISTICS!!Occupied housing units!!Lacking complete plumbing facilities',
'Percent Estimate!!SELECTED CHARACTERISTICS!!Occupied housing units!!Lacking complete plumbing facilities',
'Estimate!!SELECTED CHARACTERISTICS!!Occupied housing units!!Lacking complete kitchen facilities',
'Percent Estimate!!SELECTED CHARACTERISTICS!!Occupied housing units!!Lacking complete kitchen facilities',
'Estimate!!SELECTED CHARACTERISTICS!!Occupied housing units!!No telephone service available',
'Percent Estimate!!SELECTED CHARACTERISTICS!!Occupied housing units!!No telephone service available',
'Estimate!!VALUE!!Owner-occupied units!!Less than $50 000',
'Percent Estimate!!VALUE!!Owner-occupied units!!Less than $50 000',
'Estimate!!VALUE!!Owner-occupied units!!$50 000 to $99 999',
'Percent Estimate!!VALUE!!Owner-occupied units!!$50 000 to $99 999',
'Estimate!!VALUE!!Owner-occupied units!!$100 000 to $149 999',
'Percent Estimate!!VALUE!!Owner-occupied units!!$100 000 to $149 999',
'Estimate!!VALUE!!Owner-occupied units!!$150 000 to $199 999',
'Percent Estimate!!VALUE!!Owner-occupied units!!$150 000 to $199 999',
'Estimate!!VALUE!!Owner-occupied units!!$200 000 to $299 999',
'Percent Estimate!!VALUE!!Owner-occupied units!!$200 000 to $299 999',
'Estimate!!VALUE!!Owner-occupied units!!$300 000 to $499 999',
'Percent Estimate!!VALUE!!Owner-occupied units!!$300 000 to $499 999',
'Estimate!!VALUE!!Owner-occupied units!!$500 000 to $999 999',
'Percent Estimate!!VALUE!!Owner-occupied units!!$500 000 to $999 999',
'Estimate!!VALUE!!Owner-occupied units!!$1 000 000 or more',
'Percent Estimate!!VALUE!!Owner-occupied units!!$1 000 000 or more',
'Estimate!!VALUE!!Owner-occupied units!!Median (dollars)',
'Percent Estimate!!VALUE!!Owner-occupied units!!Median (dollars)',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!Less than 20.0 percent',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!Less than 20.0 percent',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!20.0 to 24.9 percent',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!20.0 to 24.9 percent',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!25.0 to 29.9 percent',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!25.0 to 29.9 percent',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!30.0 to 34.9 percent',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!30.0 to 34.9 percent',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!35.0 percent or more',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!35.0 percent or more',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!Not computed',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing units with a mortgage (excluding units where SMOCAPI cannot be computed)!!Not computed',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!Less than 10.0 percent',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!Less than 10.0 percent',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!10.0 to 14.9 percent',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!10.0 to 14.9 percent',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!15.0 to 19.9 percent',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!15.0 to 19.9 percent',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!20.0 to 24.9 percent',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!20.0 to 24.9 percent',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!25.0 to 29.9 percent',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!25.0 to 29.9 percent',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!30.0 to 34.9 percent',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!30.0 to 34.9 percent',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!35.0 percent or more',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!35.0 percent or more',
'Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!Not computed',
'Percent Estimate!!SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME (SMOCAPI)!!Housing unit without a mortgage (excluding units where SMOCAPI cannot be computed)!!Not computed',
'Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)',
'Percent Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)',
'Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!Less than 15.0 percent',
'Percent Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!Less than 15.0 percent',
'Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!15.0 to 19.9 percent',
'Percent Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!15.0 to 19.9 percent',
'Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!20.0 to 24.9 percent',
'Percent Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!20.0 to 24.9 percent',
'Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!25.0 to 29.9 percent',
'Percent Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!25.0 to 29.9 percent',
'Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!30.0 to 34.9 percent',
'Percent Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!30.0 to 34.9 percent',
'Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!35.0 percent or more',
'Percent Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!35.0 percent or more',
'Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!Not computed',
'Percent Estimate!!GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME (GRAPI)!!Occupied units paying rent (excluding units where GRAPI cannot be computed)!!Not computed'),
                       new = c('total_housing_units',
                              'total_housing_units_rate',
                              'occupied_housing_units',
                              'occupied_housing_units_rate',
                              'vacant_housing_units',
                              'vacant_housing_units_rate',
                              'homeowner_vacancy_rate',
                              'homeowner_vacancy_rate_rate',
                              'rental_vacancy_rate',
                              'rental_vacancy_rate_rate',
                              'built_total_housing_units',
                              'built_total_housing_units_rate',
                              'built_2014_or_later',
                              'built_2014_or_later_rate',
                              'built_2010_to_2013',
                              'built_2010_to_2013_rate',
                              'built_2000_to_2009',
                              'built_2000_to_2009_rate',
                              'built_1990_to_1999',
                              'built_1990_to_1999_rate',
                              'built_1980_to_1989',
                              'built_1980_to_1989_rate',
                              'built_1970_to_1979',
                              'built_1970_to_1979_rate',
                              'built_1960_to_1969',
                              'built_1960_to_1969_rate',
                              'built_1950_to_1959',
                              'built_1950_to_1959_rate',
                              'built_1940_to_1949',
                              'built_1940_to_1949_rate',
                              'built_1939_or_earlier',
                              'built_1939_or_earlier_rate',
                              'tenure_occupied_housing_units',
                              'tenure_occupied_housing_units_rate',
                              'owner_occupied',
                              'owner_occupied_rate',
                              'renter_occupied',
                              'renter_occupied_rate',
                              'avg_size_owner_unit',
                              'avg_size_owner_unit_rate',
                              'avg_size_renter_unit',
                              'avg_size_of_renter__unit_rate',
                              'moved_occupied_housing_unit',
                              'moved_occupied_housing_unit_rate',
                              'moved_in_2015_or_later',
                              'moved_in_2015_or_later_rate',
                              'moved_in_2010_to_2014',
                              'moved_in_2010_to_2014_rate',
                              'moved_in_2000_to_2009',
                              'moved_in_2000_to_2009_rate',
                              'moved_in_1990_to_1999',
                              'moved_in_1990_to_1999_rate',
                              'moved_in_1980_to_1989',
                              'moved_in_1980_to_1989_rate',
                              'moved_in_1979_and_earlier',
                              'moved_in_1979_and_earlier_rate',
                              'lacking_complete_plumbing_facilities',
                              'lacking_complete_plumbing_facilities_rate',
                              'lacking_complete_kitchen_facilities',
                              'lacking_complete_kitchen_facilities_rate',
                              'no_telephone_service_available',
                              'no_telephone_service_available_rate',
                              'value_less_50k',
                              'value_less_50k_rate',
                              'value_50k_100k',
                              'value_50k_100k_rate',
                              'value_100k_150k',
                              'value_100k_150k_rate',
                              'value_150k_200k',
                              'value_150k_200k_rate',
                              'value_200k_300k',
                              'value_200k_300k_rate',
                              'value_300k_500k',
                              'value_300k_500k_rate',
                              'value_500k_1M',
                              'value_500k_1M_rate',
                              'value_1M_more',
                              'value_1M_more_rate',
                              'median_value',
                              'median_value_rate',
                              'mortgage',
                              'mortgage_rate',
                              'mortgage_less_20_percent',
                              'mortgage_less_20_percent_rate',
                              'mortgage_20_25_percent',
                              'mortgage_20_25_percent_rate',
                              'mortgage_25_30_percent',
                              'mortgage_25_30_percent_rate',
                              'mortgage_30_35_percent',
                              'mortgage_30_35_percent_rate',
                              'mortgage_35_percent_plus',
                              'mortgage_35_percent_plus_rate',
                              'mortgage_not_computed',
                              'mortgage_not_computed_rate',
                              'without_mortgage',
                              'without_mortgage_rate',
                              'without_mortgage_less_10_percent',
                              'without_mortgage_less_10_percent_rate',
                              'without_mortgage_10_15_percent',
                              'without_mortgage_10_15_percent_rate',
                              'without_mortgage_15_20_percent',
                              'without_mortgage_15_20_percent_rate',
                              'without_mortgage_20_25_percent',
                              'without_mortgage_20_25_percent_rate',
                              'without_mortgage_25_30_percent',
                              'without_mortgage_25_30_percent_rate',
                              'without_mortgage_30_35_percent',
                              'without_mortgage_30_35_percent_rate',
                              'without_mortgage_35_percent_plus',
                              'without_mortgage_35_percent_plus_rate',
                              'without_mortgage_not_computed',
                              'without_mortgage_not_computed_rate',
                              'occupied_units_paying_rent',
                              'occupied_units_paying_rent_rate',
                              'rent_less_15_percent',
                              'rent_less_15_percent_rate',
                              'rent_15_20_percent',
                              'rent_15_20_percent_rate',
                              'rent_20_25_percent',
                              'rent_20_25_percent_rate',
                              'rent_25_30_percent',
                              'rent_25_30_percent_rate',
                              'rent_30_35_percent',
                              'rent_30_35_percent_rate',
                              'rent_35_percent_plus',
                              'rent_35_percent_plus_rate',
                              'rent_not_computed',
                              'rent_not_computed_rate'))
  
# Keep required fields
d_housing <- d_housing[ , c('censusid', 'total_housing_units',
                              'total_housing_units_rate',
                              'occupied_housing_units',
                              'occupied_housing_units_rate',
                              'vacant_housing_units',
                              'vacant_housing_units_rate',
                              'homeowner_vacancy_rate',
                              'homeowner_vacancy_rate_rate',
                              'rental_vacancy_rate',
                              'rental_vacancy_rate_rate',
                              'built_total_housing_units',
                              'built_total_housing_units_rate',
                              'built_2014_or_later',
                              'built_2014_or_later_rate',
                              'built_2010_to_2013',
                              'built_2010_to_2013_rate',
                              'built_2000_to_2009',
                              'built_2000_to_2009_rate',
                              'built_1990_to_1999',
                              'built_1990_to_1999_rate',
                              'built_1980_to_1989',
                              'built_1980_to_1989_rate',
                              'built_1970_to_1979',
                              'built_1970_to_1979_rate',
                              'built_1960_to_1969',
                              'built_1960_to_1969_rate',
                              'built_1950_to_1959',
                              'built_1950_to_1959_rate',
                              'built_1940_to_1949',
                              'built_1940_to_1949_rate',
                              'built_1939_or_earlier',
                              'built_1939_or_earlier_rate',
                              'tenure_occupied_housing_units',
                              'tenure_occupied_housing_units_rate',
                              'owner_occupied',
                              'owner_occupied_rate',
                              'renter_occupied',
                              'renter_occupied_rate',
                              'avg_size_owner_unit',
                              'avg_size_owner_unit_rate',
                              'avg_size_renter_unit',
                              'avg_size_of_renter__unit_rate',
                              'moved_occupied_housing_unit',
                              'moved_occupied_housing_unit_rate',
                              'moved_in_2015_or_later',
                              'moved_in_2015_or_later_rate',
                              'moved_in_2010_to_2014',
                              'moved_in_2010_to_2014_rate',
                              'moved_in_2000_to_2009',
                              'moved_in_2000_to_2009_rate',
                              'moved_in_1990_to_1999',
                              'moved_in_1990_to_1999_rate',
                              'moved_in_1980_to_1989',
                              'moved_in_1980_to_1989_rate',
                              'moved_in_1979_and_earlier',
                              'moved_in_1979_and_earlier_rate',
                              'lacking_complete_plumbing_facilities',
                              'lacking_complete_plumbing_facilities_rate',
                              'lacking_complete_kitchen_facilities',
                              'lacking_complete_kitchen_facilities_rate',
                              'no_telephone_service_available',
                              'no_telephone_service_available_rate',
                              'value_less_50k',
                              'value_less_50k_rate',
                              'value_50k_100k',
                              'value_50k_100k_rate',
                              'value_100k_150k',
                              'value_100k_150k_rate',
                              'value_150k_200k',
                              'value_150k_200k_rate',
                              'value_200k_300k',
                              'value_200k_300k_rate',
                              'value_300k_500k',
                              'value_300k_500k_rate',
                              'value_500k_1M',
                              'value_500k_1M_rate',
                              'value_1M_more',
                              'value_1M_more_rate',
                              'median_value',
                              'median_value_rate',
                              'mortgage',
                              'mortgage_rate',
                              'mortgage_less_20_percent',
                              'mortgage_less_20_percent_rate',
                              'mortgage_20_25_percent',
                              'mortgage_20_25_percent_rate',
                              'mortgage_25_30_percent',
                              'mortgage_25_30_percent_rate',
                              'mortgage_30_35_percent',
                              'mortgage_30_35_percent_rate',
                              'mortgage_35_percent_plus',
                              'mortgage_35_percent_plus_rate',
                              'mortgage_not_computed',
                              'mortgage_not_computed_rate',
                              'without_mortgage',
                              'without_mortgage_rate',
                              'without_mortgage_less_10_percent',
                              'without_mortgage_less_10_percent_rate',
                              'without_mortgage_10_15_percent',
                              'without_mortgage_10_15_percent_rate',
                              'without_mortgage_15_20_percent',
                              'without_mortgage_15_20_percent_rate',
                              'without_mortgage_20_25_percent',
                              'without_mortgage_20_25_percent_rate',
                              'without_mortgage_25_30_percent',
                              'without_mortgage_25_30_percent_rate',
                              'without_mortgage_30_35_percent',
                              'without_mortgage_30_35_percent_rate',
                              'without_mortgage_35_percent_plus',
                              'without_mortgage_35_percent_plus_rate',
                              'without_mortgage_not_computed',
                              'without_mortgage_not_computed_rate',
                              'occupied_units_paying_rent',
                              'occupied_units_paying_rent_rate',
                              'rent_less_15_percent',
                              'rent_less_15_percent_rate',
                              'rent_15_20_percent',
                              'rent_15_20_percent_rate',
                              'rent_20_25_percent',
                              'rent_20_25_percent_rate',
                              'rent_25_30_percent',
                              'rent_25_30_percent_rate',
                              'rent_30_35_percent',
                              'rent_30_35_percent_rate',
                              'rent_35_percent_plus',
                              'rent_35_percent_plus_rate',
                              'rent_not_computed',
                              'rent_not_computed_rate')]


# Three built year ranges
d_housing[ , `:=` (built_1959_or_earlier_rate = (built_1939_or_earlier + built_1940_to_1949 + built_1950_to_1959)/built_total_housing_units,
    built_1960_to_1989_rate = (built_1960_to_1969 + built_1970_to_1979 + built_1980_to_1989)/built_total_housing_units,
    built_1990_or_later_rate = (built_1990_to_1999 + built_2000_to_2009 + built_2010_to_2013 + built_2014_or_later)/built_total_housing_units)]

# Two built year ranges
d_housing[ , `:=` (built_1979_or_earlier_rate = (built_1939_or_earlier + built_1940_to_1949 + built_1950_to_1959 + built_1960_to_1969 + built_1970_to_1979)/built_total_housing_units,
                   built_1980_or_later_rate = (built_1980_to_1989 + built_1990_to_1999 + built_2000_to_2009 + built_2010_to_2013 + built_2014_or_later)/built_total_housing_units)]

# Convert percentages to proportions
d_housing[ ,`:=` (owner_occupied_rate = owner_occupied/tenure_occupied_housing_units,
                  renter_occupied_rate = renter_occupied/tenure_occupied_housing_units)]
                  
# Left join to full data
d_full <- merge(x = d_full, y = d_housing, by = 'censusid', all.x = TRUE)
tail(d_full)
```



## Race in United States

```{r}
# Read data
d_race_us <-read_data(file = '../data/census-tract/raw/race-us.csv')
d_race_us

# Rename fields
setnames(d_race_us, old = c('Estimate!!Total!!Total population!!Hispanic or Latino origin (of any race)',
'Estimate!!Native; born in state of residence!!Total population!!Hispanic or Latino origin (of any race)',
'Estimate!!Native; born in other state in the U.S.!!Total population!!Hispanic or Latino origin (of any race)',
'Estimate!!Native; born outside U.S.!!Total population!!Hispanic or Latino origin (of any race)',
'Estimate!!Total!!Total population!!White alone, not Hispanic or Latino',
'Estimate!!Native; born in state of residence!!Total population!!White alone, not Hispanic or Latino',
'Estimate!!Native; born in other state in the U.S.!!Total population!!White alone, not Hispanic or Latino',
'Estimate!!Native; born outside U.S.!!Total population!!White alone, not Hispanic or Latino',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race',
'Estimate!!Native; born in state of residence!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race',
'Estimate!!Native; born in other state in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race',
'Estimate!!Native; born outside U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!White',
'Estimate!!Native; born in state of residence!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!White',
'Estimate!!Native; born in other state in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!White',
'Estimate!!Native; born outside U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!White',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Black or African American',
'Estimate!!Native; born in state of residence!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Black or African American',
'Estimate!!Native; born in other state in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Black or African American',
'Estimate!!Native; born outside U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Black or African American',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!American Indian and Alaska Native',
'Estimate!!Native; born in state of residence!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!American Indian and Alaska Native',
'Estimate!!Native; born in other state in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!American Indian and Alaska Native',
'Estimate!!Native; born outside U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!American Indian and Alaska Native',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Asian',
'Estimate!!Native; born in state of residence!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Asian',
'Estimate!!Native; born in other state in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Asian',
'Estimate!!Native; born outside U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Asian',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Native Hawaiian and Other Pacific Islander',
'Estimate!!Native; born in state of residence!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Native Hawaiian and Other Pacific Islander',
'Estimate!!Native; born in other state in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Native Hawaiian and Other Pacific Islander',
'Estimate!!Native; born outside U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Native Hawaiian and Other Pacific Islander',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Some other race',
'Estimate!!Native; born in state of residence!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Some other race',
'Estimate!!Native; born in other state in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Some other race',
'Estimate!!Native; born outside U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Some other race'),
                      new = c('us_total_hispanic_rate',
                              'us_in_state_hispanic_rate',
                              'us_out_state_hispanic_rate',
                              'us_outside_hispanic_rate',
                              'us_total_white_alone_rate',
                              'us_in_state_white_alone_rate',
                              'us_out_state_white_alone_rate',
                              'us_outside_white_alone_rate',
                              'us_total_race_rate',
                              'us_in_state_race_rate',
                              'us_out_state_race_rate',
                              'us_outside_race_rate',
                              'us_total_white_rate',
                              'us_in_state_white_rate',
                              'us_out_state_white_rate',
                              'us_outside_white_rate',
                              'us_total_black_rate',
                              'us_in_state_black_rate',
                              'us_out_state_black_rate',
                              'us_outside_black_rate',
                              'us_total_american_indian_rate',
                              'us_in_state_american_indian_rate',
                              'us_out_state_american_indian_rate',
                              'us_outside_american_indian_rate',
                              'us_total_asian_rate',
                              'us_in_state_asian_rate',
                              'us_out_state_asian_rate',
                              'us_outside_asian_rate',
                              'us_total_native_hawaiian_rate',
                              'us_in_state_native_hawaiian_rate',
                              'us_out_state_native_hawaiian_rate',
                              'us_outside_native_hawaiian_rate',
                              'us_total_other_rate',
                              'us_in_state_other_rate',
                              'us_out_state_other_rate',
                              'us_outside_other_rate'))

# Keep required fields
d_race_us <- d_race_us[ , c('censusid',
                            'us_total_hispanic_rate',
                            'us_in_state_hispanic_rate',
                            'us_out_state_hispanic_rate',
                            'us_outside_hispanic_rate',
                            'us_total_white_alone_rate',
                            'us_in_state_white_alone_rate',
                            'us_out_state_white_alone_rate',
                            'us_outside_white_alone_rate',
                            'us_total_race_rate',
                            'us_in_state_race_rate',
                            'us_out_state_race_rate',
                            'us_outside_race_rate',
                            'us_total_white_rate',
                            'us_in_state_white_rate',
                            'us_out_state_white_rate',
                            'us_outside_white_rate',
                            'us_total_black_rate',
                            'us_in_state_black_rate',
                            'us_out_state_black_rate',
                            'us_outside_black_rate',
                            'us_total_american_indian_rate',
                            'us_in_state_american_indian_rate',
                            'us_out_state_american_indian_rate',
                            'us_outside_american_indian_rate',
                            'us_total_asian_rate',
                            'us_in_state_asian_rate',
                            'us_out_state_asian_rate',
                            'us_outside_asian_rate',
                            'us_total_native_hawaiian_rate',
                            'us_in_state_native_hawaiian_rate',
                            'us_out_state_native_hawaiian_rate',
                            'us_outside_native_hawaiian_rate',
                            'us_total_other_rate',
                            'us_in_state_other_rate',
                            'us_out_state_other_rate',
                            'us_outside_other_rate')]

# Convert to numeric
d_race_us[ , `:=` (us_total_hispanic_rate = as.numeric(us_total_hispanic_rate),
                   us_in_state_hispanic_rate = as.numeric(us_in_state_hispanic_rate),
                   us_out_state_hispanic_rate = as.numeric(us_out_state_hispanic_rate),
                   us_outside_hispanic_rate = as.numeric(us_outside_hispanic_rate),
                   us_total_white_alone_rate = as.numeric(us_total_white_alone_rate),
                   us_in_state_white_alone_rate = as.numeric(us_in_state_white_alone_rate),
                   us_out_state_white_alone_rate = as.numeric(us_out_state_white_alone_rate),
                   us_outside_white_alone_rate = as.numeric(us_outside_white_alone_rate),
                   us_total_race_rate = as.numeric(us_total_race_rate),
                   us_in_state_race_rate = as.numeric(us_in_state_race_rate),
                   us_out_state_race_rate = as.numeric(us_out_state_race_rate),
                   us_outside_race_rate = as.numeric(us_outside_race_rate),
                   us_total_white_rate = as.numeric(us_total_white_rate),
                   us_in_state_white_rate = as.numeric(us_in_state_white_rate),
                   us_out_state_white_rate = as.numeric(us_out_state_white_rate),
                   us_outside_white_rate = as.numeric(us_outside_white_rate),
                   us_total_black_rate = as.numeric(us_total_black_rate),
                   us_in_state_black_rate = as.numeric(us_in_state_black_rate),
                   us_out_state_black_rate = as.numeric(us_out_state_black_rate),
                   us_outside_black_rate = as.numeric(us_outside_black_rate),
                   us_total_american_indian_rate = as.numeric(us_total_american_indian_rate),
                   us_in_state_american_indian_rate = as.numeric(us_in_state_american_indian_rate),
                   us_out_state_american_indian_rate = as.numeric(us_out_state_american_indian_rate),
                   us_outside_american_indian_rate = as.numeric(us_outside_american_indian_rate),
                   us_total_asian_rate = as.numeric(us_total_asian_rate),
                   us_in_state_asian_rate = as.numeric(us_in_state_asian_rate),
                   us_out_state_asian_rate = as.numeric(us_out_state_asian_rate),
                   us_outside_asian_rate = as.numeric(us_outside_asian_rate),
                   us_total_native_hawaiian_rate = as.numeric(us_total_native_hawaiian_rate),
                   us_in_state_native_hawaiian_rate = as.numeric(us_in_state_native_hawaiian_rate),
                   us_out_state_native_hawaiian_rate = as.numeric(us_out_state_native_hawaiian_rate),
                   us_outside_native_hawaiian_rate = as.numeric(us_outside_native_hawaiian_rate),
                   us_total_other_rate = as.numeric(us_total_other_rate),
                   us_in_state_other_rate = as.numeric(us_in_state_other_rate),
                   us_out_state_other_rate = as.numeric(us_out_state_other_rate),
                   us_outside_other_rate = as.numeric(us_outside_other_rate))]

# Create certain groups
d_race_us[ , `:=` (us_total_other_rate = us_total_american_indian_rate + us_total_asian_rate + us_total_native_hawaiian_rate + us_total_other_rate)]
d_race_us[ , `:=` (us_total_nonwhite_rate = us_total_black_rate + us_total_hispanic_rate + us_total_asian_rate + us_total_other_rate)]

# Left join to full data
d_full <- merge(x = d_full, y = d_race_us, by = 'censusid', all.x = TRUE)
head(d_full)
```


## Race in Puerto Rico

```{r}
# Read data
d_race_pr <-read_data(file = '../data/census-tract/raw/race-pr.csv')
d_race_pr

# Rename fields
setnames(d_race_pr, old = c('Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Black or African American',
'Estimate!!Native; born in Puerto Rico!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Black or African American',
'Estimate!!Native; born in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Black or African American',
'Estimate!!Native; born outside Puerto Rico and the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Black or African American',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!American Indian and Alaska Native',
'Estimate!!Native; born in Puerto Rico!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!American Indian and Alaska Native',
'Estimate!!Native; born in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!American Indian and Alaska Native',
'Estimate!!Native; born outside Puerto Rico and the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!American Indian and Alaska Native',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Asian',
'Estimate!!Native; born in Puerto Rico!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Asian',
'Estimate!!Native; born in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Asian',
'Estimate!!Native; born outside Puerto Rico and the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Asian',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Native Hawaiian and Other Pacific Islander',
'Estimate!!Native; born in Puerto Rico!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Native Hawaiian and Other Pacific Islander',
'Estimate!!Native; born in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Native Hawaiian and Other Pacific Islander',
'Estimate!!Native; born outside Puerto Rico and the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Native Hawaiian and Other Pacific Islander',
'Estimate!!Total!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Some other race',
'Estimate!!Native; born in Puerto Rico!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Some other race',
'Estimate!!Native; born in the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Some other race',
'Estimate!!Native; born outside Puerto Rico and the U.S.!!Total population!!RACE AND HISPANIC OR LATINO ORIGIN!!One race!!Some other race',
'Estimate!!Total!!Total population!!Hispanic or Latino origin (of any race)',
'Estimate!!Native; born in Puerto Rico!!Total population!!Hispanic or Latino origin (of any race)',
'Estimate!!Native; born in the U.S.!!Total population!!Hispanic or Latino origin (of any race)',
'Estimate!!Native; born outside Puerto Rico and the U.S.!!Total population!!Hispanic or Latino origin (of any race)',
'Estimate!!Total!!Total population!!White alone, not Hispanic or Latino',
'Estimate!!Native; born in Puerto Rico!!Total population!!White alone, not Hispanic or Latino',
'Estimate!!Native; born in the U.S.!!Total population!!White alone, not Hispanic or Latino',
'Estimate!!Native; born outside Puerto Rico and the U.S.!!Total population!!White alone, not Hispanic or Latino'),
                      new = c('pr_total_black_rate',
                              'pr_born_in_black_rate',
                              'pr_born_us_black_rate',
                              'pr_born_outside_black_rate',
                              'pr_total_american_indian_rate',
                              'pr_born_in_american_indiane_rate',
                              'pr_born_us_american_indian_rate',
                              'pr_born_outside_american_indian_rate',
                              'pr_total_asian_rate',
                              'pr_born_in_asian_rate',
                              'pr_born_us_asian_rate',
                              'pr_born_outside_asian_rate',
                              'pr_total_native_hawaiian_rate',
                              'pr_born_in_native_hawaiian_rate',
                              'pr_born_us_native_hawaiian_rate',
                              'pr_born_outside_native_hawaiian_rate',
                              'pr_total_other_rate',
                              'pr_born_in_other_rate',
                              'pr_born_us_other_rate',
                              'pr_born_outside_other_rate',
                              'pr_total_hispanic_rate',
                              'pr_born_in_hispanic_rate',
                              'pr_born_us_hispanic_rate',
                              'pr_born_outside_hispanic_rate',
                              'pr_total_white_alone_rate',
                              'pr_born_in_white_alone_rate',
                              'pr_born_us_white_alone_rate',
                              'pr_born_outside_white_alone_rate'))

# Keep required fields
d_race_pr <- d_race_pr[ , c('censusid',
                            'pr_total_black_rate',
                            'pr_born_in_black_rate',
                            'pr_born_us_black_rate',
                            'pr_born_outside_black_rate',
                            'pr_total_american_indian_rate',
                            'pr_born_in_american_indiane_rate',
                            'pr_born_us_american_indian_rate',
                            'pr_born_outside_american_indian_rate',
                            'pr_total_asian_rate',
                            'pr_born_in_asian_rate',
                            'pr_born_us_asian_rate',
                            'pr_born_outside_asian_rate',
                            'pr_total_native_hawaiian_rate',
                            'pr_born_in_native_hawaiian_rate',
                            'pr_born_us_native_hawaiian_rate',
                            'pr_born_outside_native_hawaiian_rate',
                            'pr_total_other_rate',
                            'pr_born_in_other_rate',
                            'pr_born_us_other_rate',
                            'pr_born_outside_other_rate',
                            'pr_total_hispanic_rate',
                            'pr_born_in_hispanic_rate',
                            'pr_born_us_hispanic_rate',
                            'pr_born_outside_hispanic_rate',
                            'pr_total_white_alone_rate',
                            'pr_born_in_white_alone_rate',
                            'pr_born_us_white_alone_rate',
                            'pr_born_outside_white_alone_rate')]

# Convert to numeric
d_race_pr[ , `:=` (pr_total_black_rate = as.numeric(pr_total_black_rate),
                   pr_born_in_black_rate = as.numeric(pr_born_in_black_rate),
                   pr_born_us_black_rate = as.numeric(pr_born_us_black_rate),
                   pr_born_outside_black_rate = as.numeric(pr_born_outside_black_rate),
                   pr_total_american_indian_rate = as.numeric(pr_total_american_indian_rate),
                   pr_born_in_american_indiane_rate = as.numeric(pr_born_in_american_indiane_rate),
                   pr_born_us_american_indian_rate = as.numeric(pr_born_us_american_indian_rate),
                   pr_born_outside_american_indian_rate = as.numeric(pr_born_outside_american_indian_rate),
                   pr_total_asian_rate = as.numeric(pr_total_asian_rate),
                   pr_born_us_asian_rate = as.numeric(pr_born_us_asian_rate),
                   pr_born_outside_asian_rate = as.numeric(pr_born_outside_asian_rate),
                   pr_total_native_hawaiian_rate = as.numeric(pr_total_native_hawaiian_rate),
                   pr_born_in_native_hawaiian_rate = as.numeric(pr_born_in_native_hawaiian_rate),
                   pr_born_us_native_hawaiian_rate = as.numeric(pr_born_us_native_hawaiian_rate),
                   pr_born_outside_native_hawaiian_rate = as.numeric(pr_born_outside_native_hawaiian_rate),
                   pr_total_other_rate = as.numeric(pr_total_other_rate),
                   pr_born_in_other_rate = as.numeric(pr_born_in_other_rate),
                   pr_born_us_other_rate = as.numeric(pr_born_us_other_rate),
                   pr_born_outside_other_rate = as.numeric(pr_born_outside_other_rate),
                   pr_total_hispanic_rate = as.numeric(pr_total_hispanic_rate),
                   pr_born_in_hispanic_rate = as.numeric(pr_born_in_hispanic_rate),
                   pr_born_us_hispanic_rate = as.numeric(pr_born_us_hispanic_rate),
                   pr_born_outside_hispanic_rate = as.numeric(pr_born_outside_hispanic_rate),
                   pr_total_white_alone_rate = as.numeric(pr_total_white_alone_rate),
                   pr_born_in_white_alone_rate = as.numeric(pr_born_in_white_alone_rate),
                   pr_born_us_white_alone_rate = as.numeric(pr_born_us_white_alone_rate),
                   pr_born_outside_white_alone_rate = as.numeric(pr_born_outside_white_alone_rate))]

# Create certain groups
d_race_pr[ , `:=` (pr_total_other_rate = pr_total_american_indian_rate + pr_total_asian_rate + pr_total_native_hawaiian_rate + pr_total_other_rate)]
d_race_pr[ , `:=` (pr_total_nonwhite_rate = pr_total_black_rate + pr_total_hispanic_rate + pr_total_asian_rate + pr_total_other_rate)]

# Left join to full data
d_full <- merge(x = d_full, y = d_race_pr, by = 'censusid', all.x = TRUE)

# Combined US/PR rates into single race
d_full[ ,`:=` (total_white_alone_rate = ifelse(substr(tractid,1,2) == '72', pr_total_white_alone_rate/100, us_total_white_alone_rate/100),
                total_black_rate = ifelse(substr(tractid,1,2) == '72', pr_total_black_rate/100, us_total_black_rate/100),
                total_hispanic_rate = ifelse(substr(tractid,1,2) == '72', pr_total_hispanic_rate/100, us_total_hispanic_rate/100),
                total_other_rate = ifelse(substr(tractid,1,2) == '72', pr_total_other_rate/100, us_total_other_rate/100),
                total_nonwhite_rate = ifelse(substr(tractid,1,2) == '72', pr_total_nonwhite_rate/100, us_total_nonwhite_rate/100))]

head(d_full)
```


## Nativity and Citizenship

```{r}
# Read data
d_citizen <- read_data(file = '../data/census-tract/raw/nativity-citizenship.csv')
d_citizen

# Rename fields
setnames(d_citizen, old = c('Estimate!!Total',
                            'Estimate!!Total!!Native',
                            'Estimate!!Total!!Native!!Born in state of residence',
                            'Estimate!!Total!!Native!!Born in other state in the United States',
                            'Estimate!!Total!!Native!!Born outside the United States',
                            'Estimate!!Total!!Native!!Born outside the United States!!Puerto Rico',
                            'Estimate!!Total!!Native!!Born outside the United States!!U.S. Island Areas',
                            'Estimate!!Total!!Native!!Born outside the United States!!Born abroad of American parent(s)',
                            'Estimate!!Total!!Foreign born',
                            'Estimate!!Total!!Foreign born!!Naturalized U.S. citizen',
                            'Estimate!!Total!!Foreign born!!Not a U.S. citizen'),
                     new = c('total_population_nativity',
                             'total_native',
                             'native_in_state',
                             'native_out_state',
                             'native_outside_us',
                             'native_outside_us_puerto',
                             'native_outside_us_islands',
                             'native_outside_us_abroad',
                             'total_foreign',
                             'foreign_citizen',
                             'foreign_non_citizen'))

# Keep required fields
d_citizen <- d_citizen[ , c('censusid',
                            'total_population_nativity',
                            'total_native',
                            'native_in_state',
                            'native_out_state',
                            'native_outside_us',
                            'native_outside_us_puerto',
                            'native_outside_us_islands',
                            'native_outside_us_abroad',
                            'total_foreign',
                            'foreign_citizen',
                            'foreign_non_citizen')]

# Calculate rates
d_citizen[ , `:=` (total_native_rate = total_native/total_population_nativity,
                      native_in_state_rate = native_in_state/total_population_nativity,
                      native_out_state_rate = native_out_state/total_population_nativity,
                      native_outside_us_rate = native_outside_us/total_population_nativity,
                      native_outside_us_puerto_rate = native_outside_us_puerto/total_population_nativity,
                      native_outside_us_islands_rate = native_outside_us_islands/total_population_nativity,
                      native_outside_us_abroad_rate = native_outside_us_abroad/total_population_nativity,
                      total_foreign_rate = total_foreign/total_population_nativity,
                      foreign_citizen_rate = foreign_citizen/total_population_nativity,
                      foreign_non_citizen_rate = foreign_non_citizen/total_population_nativity)]

# Left join to full data
d_full <- merge(x = d_full, y = d_citizen, by = 'censusid', all.x = TRUE)
d_full
```

## Extreme Estimates Clean-Up

```{r}
# Replace '-' estimates with NAs - median earnings and median value
d_full$median_earnings_total[d_full$median_earnings_total %like% '-'] <- NA
d_full$median_earnings_male[d_full$median_earnings_male %like% '-'] <- NA
d_full$median_earnings_male_fulltime[d_full$median_earnings_male_fulltime %like% '-'] <- NA
d_full$median_earnings_male_other[d_full$median_earnings_male_other %like% '-'] <- NA
d_full$median_earnings_female[d_full$median_earnings_female %like% '-'] <- NA
d_full$median_earnings_female_fulltime[d_full$median_earnings_female_fulltime %like% '-'] <- NA
d_full$median_earnings_female_other[d_full$median_earnings_female_other %like% '-'] <- NA
d_full$median_value[d_full$median_value %like% '-'] <- NA

# Replace '+' estimates with NAs - median earnings and median value
d_full$median_earnings_total[d_full$median_earnings_total %like% '\\+'] <- NA
d_full$median_earnings_male[d_full$median_earnings_male %like% '\\+'] <- NA
d_full$median_earnings_male_fulltime[d_full$median_earnings_male_fulltime %like% '\\+'] <- NA
d_full$median_earnings_male_other[d_full$median_earnings_male_other %like% '\\+'] <- NA
d_full$median_earnings_female[d_full$median_earnings_female %like% '\\+'] <- NA
d_full$median_earnings_female_fulltime[d_full$median_earnings_female_fulltime %like% '\\+'] <- NA
d_full$median_earnings_female_other[d_full$median_earnings_female_other %like% '\\+'] <- NA
d_full$median_value[d_full$median_value %like% '\\+'] <- NA

# Convert to numeric post clean-up
d_full[ , `:=` (median_earnings_total = as.numeric(median_earnings_total),
                median_earnings_male = as.numeric(median_earnings_male),
                median_earnings_male_fulltime = as.numeric(median_earnings_male_fulltime),
                median_earnings_male_other = as.numeric(median_earnings_male_other),
                median_earnings_female = as.numeric(median_earnings_female),
                median_earnings_female_fulltime = as.numeric(median_earnings_female_fulltime),
                median_earnings_female_other = as.numeric(median_earnings_female_other),
                median_value = as.numeric(median_value))]
```


## GIS Coordinates for Tracts (Latitude/Longitude)

```{r}
# Read data
d_gis <- fread(file = '../data/census-tract-shapefile/nhgis-tract-2017.csv', encoding = 'UTF-8')
d_gis

# Convert variables names to lower case
names(d_gis) <- tolower(names(d_gis))

# Create tract id
d_gis[ , `:=` (tractid = paste0(substr(gisjoin, 2, 3), substr(gisjoin, 5, 7), substr(gisjoin, 9, 14)))]

# Keep specific variables
d_gis <- d_gis[ , c('gisjoin', 'tractid', 'county', 'state')]

# Left join to full data
d_full <- merge(x = d_full, y = d_gis, by = 'tractid', all.x = TRUE)

# Reorder variables
d_full <- d_full %>%
  select(state, everything()) %>%
  select(county, everything()) %>%
  select(tractname, everything()) %>%
  select(tractid, everything()) %>%
  select(gisjoin, everything()) %>%
  select(censusid, everything())

tail(d_full)
```

```{r}
# Write to csv
fwrite(d_full, file = '../data/census-tract/census-tract-demographics.csv')
```



# Disaster Vulnerability Index

```{r}
# Read in data
d_census <- fread(file = '../data/census-tract/census-tract-demographics.csv', encoding='UTF-8')

# Keep key demographics
d_census <- d_census[ , c('censusid',
                          'below_poverty_rate',
                          'unemployed_labor_rate',
                          'median_earnings_total',
                          'owner_occupied_rate',
                          'built_1979_or_earlier_rate', 'built_1980_or_later_rate')]

#'total_white_alone_rate', 'total_black_rate', 'total_hispanic_rate', 'total_other_rate'
#'total_native_rate', 'foreign_citizen_rate', 'foreign_non_citizen_rate'

head(d_census)
summary(d_census)

# Select rows with any NAs
d_census[rowSums(is.na(d_census)) > 0, ]
```


```{r}
# Percentile ranking function
percent_rank_asc <- function(x) trunc((rank(x)-1))/(length(x)-1)
percent_rank_desc <- function(x) trunc((rank(desc(x))-1))/(length(x)-1)
```

## Below Poverty Rate

```{r}
# Drop NAs
d_valid <- d_census[!is.na(below_poverty_rate), c('censusid', 'below_poverty_rate')]

# Calculate percentile rank
d_valid <- within(d_valid, 'poverty_rank' <- percent_rank_asc(d_valid$below_poverty_rate))
d_valid <- d_valid[ , c('censusid', 'poverty_rank')]

d_rank <- merge(x = d_census, y = d_valid, by = 'censusid', all.x = TRUE)
```

## Unemployed Rate

```{r}
# Drop NAs
d_valid <- d_census[!is.na(unemployed_labor_rate), c('censusid', 'unemployed_labor_rate')]

# Calculate percentile rank
d_valid <- within(d_valid, 'unemployed_rank' <- percent_rank_asc(d_valid$unemployed_labor_rate))
d_valid <- d_valid[ , c('censusid', 'unemployed_rank')]

d_rank <- merge(x = d_rank, y = d_valid, by = 'censusid', all.x = TRUE)
```

## Median Earnings

```{r}
# Drop NAs
d_valid <- d_census[!is.na(median_earnings_total), c('censusid', 'median_earnings_total')]

# Calculate percentile rank
d_valid <- within(d_valid, 'earnings_rank' <- percent_rank_desc(d_valid$median_earnings_total))
d_valid <- d_valid[ , c('censusid', 'earnings_rank')]

d_rank <- merge(x = d_rank, y = d_valid, by = 'censusid', all.x = TRUE)
```

## Owner Occupied Rate

```{r}
# Drop NAs
d_valid <- d_census[!is.na(owner_occupied_rate), c('censusid', 'owner_occupied_rate')]

# Calculate percentile rank
d_valid <- within(d_valid, 'owner_rank' <- percent_rank_asc(d_valid$owner_occupied_rate))
d_valid <- d_valid[ , c('censusid', 'owner_rank')]

d_rank <- merge(x = d_rank, y = d_valid, by = 'censusid', all.x = TRUE)
```

## House Built Year

```{r}
# Drop NAs
d_valid <- d_census[!is.na(built_1979_or_earlier_rate), c('censusid', 'built_1979_or_earlier_rate')]

# Calculate percentile rank
d_valid <- within(d_valid, 'house_old_rank' <- percent_rank_asc(d_valid$built_1979_or_earlier_rate))
d_valid <- d_valid[ , c('censusid', 'house_old_rank')]

d_rank <- merge(x = d_rank, y = d_valid, by = 'censusid', all.x = TRUE)
```

## Vulnerability Index

```{r}
# Raw Disaster Vulnerability Index (SVI)
d_rank[ ,`:=` (dvi_raw = poverty_rank + unemployed_rank + earnings_rank + owner_rank + house_old_rank)]

# Keep ranks and index
d_trim <- d_rank[ , c('censusid', 'poverty_rank', 'unemployed_rank', 'earnings_rank',
                      'owner_rank', 'house_old_rank', 'dvi_raw')]

# Remove rows with NAs
(d_trim <- na.omit(d_trim))
```

```{r}
# Min-max scaling
normalize <- function(x) {
    return((x- min(x)) /(max(x)-min(x)))
}
# Scale SDI
d_trim$dvi <- normalize(d_trim$dvi_raw)

head(d_trim)
```


```{r fig.width=12, fig.height=4}
# Raw DVI
p_raw <- ggplot(d_trim, aes(x=dvi_raw)) + 
  geom_density() +
  ggtitle('Raw Disaster Index') +
  theme_minimal() +
  labs(x = 'Raw DVI')

# Scaled DVI
p_scaled <- ggplot(d_trim, aes(x=dvi)) + 
  geom_density() +
  ggtitle('Scaled Disaster Index') +
  theme_minimal() +
  labs(x = 'Scaled DVI')

grid.arrange(p_raw, p_scaled, ncol = 2)
```

```{r}
# Write to csv
fwrite(d_trim, file = '../data/census-tract/census-tract-dvi.csv')
```

## Add DVI into Full Demographics File

```{r}
# Merge DVI score into full demographics
d_full <- merge(x = d_full, y = d_trim, by = 'censusid', all.x = TRUE)

head(d_full)
```

```{r}
# Write to csv
fwrite(d_full, file = '../data/census-tract/census-tract-demographics.csv')
```

