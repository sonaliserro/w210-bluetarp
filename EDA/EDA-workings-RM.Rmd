---
title: 'FEMA EDA'
subtitle: 'Individual and Households Program - Hurricane Maria'
author: 'Ross MacLean'
geometry: margin=1in
output:
  github_document: default
  pdf_document: default
  toc: yes
  number_sections: yes
fontsize: 11pt
knit: (function(inputFile, encoding) {
  rmarkdown::render(
    inputFile, encoding = encoding,
    output_format = c('github_document', 'pdf_document'))
    })
---

```{r}
# Load packages
library(car)
library(dplyr)
library(data.table)
library(ggplot2)
library(ggcorrplot)
library(gridExtra)
library(GGally)
library(knitr)
```

```{r}
# Turn of scientific notation
options(scipen=999)
```

# 1. Exploratory Data Analysis

These questions are taken from Question 12 of chapter of the textbook.

```{r}
# Read data
d_fema <- data.frame(fread(file = '../data/FEMA-DR-4339-PR.csv', fill = TRUE))

# Convert variables names to lower case
names(d_fema) <- tolower(names(d_fema))

# Convert boolean to numeric
cols <- sapply(d_fema, is.logical)
d_fema[, cols] <- lapply(d_fema[, cols], as.numeric)
d_fema <- data.table(d_fema)

# Rename variables
setnames(d_fema, old = c('damagedcity', 'damagedstateabbreviation', 'damagedzipcode'),
                 new = c('city', 'state', 'zipcode'))

head(d_fema)
```

## High-level Summaries

```{r}
summary(d_fema)
```

- IHP referral: 80%
- IHP eligible: 42%
- IHP Amount: $1993

- Flood insurance: 7%
- Other Needs Assistance (ONA) referral: 57%

- House Damaged: 64%
- Homeowners insurance: 15%
- HA referral: 67%
- HA eligible: 20
- HA amount: $685

- Utilities out: 94%
- Food need: 100%

- Inspected: 68%

```{r}
#d[ownrent == 'Owner' , .(count = .N), keyby=c('ownrent', 'hastatus')]
```

## HA Status Investigation

```{r, fig.width=10, fig.height=4.5}
# HA status
(d_hastatus <- d_fema[ , .(count = .N,
                           ihpeligible = sum(ihpeligible),
                           haeligible = sum(haeligible),                  
                           ihpamount = mean(ihpamount),
                           haamount = mean(haamount),
                           onaamount = mean(onaamount),
                           replacementamount = mean(replacementamount)), keyby=hastatus])

# Counts - reorder and select top 10
d_hastatus$hastatus <- factor(d_hastatus$hastatus, levels = d_hastatus$hastatus[order(d_hastatus$count)])
top_n <- head(d_hastatus[order(count, decreasing = TRUE)], 10)

ggplot(top_n, aes(x=hastatus, y=count)) +
                geom_col() +
                coord_flip() +
                labs(title = 'Counts',
                     x = 'HA status',
                     y = 'Count')

# IHP eligible - reorder and select top 10
d_hastatus$hastatus <- factor(d_hastatus$hastatus, levels = d_hastatus$hastatus[order(d_hastatus$ihpeligible)])
top_n <- head(d_hastatus[order(ihpeligible, decreasing = TRUE)], 10)

ggplot(top_n, aes(x=hastatus, y=ihpeligible)) +
                geom_col() +
                coord_flip() +
                labs(title = 'IHP Eligible',
                     x = 'HA status',
                     y = 'IHP eligible ($)')

# IHP amount - reorder and select top 10
d_hastatus$hastatus <- factor(d_hastatus$hastatus, levels = d_hastatus$hastatus[order(d_hastatus$ihpamount)])
top_n <- head(d_hastatus[order(ihpamount, decreasing = TRUE)], 10)

ggplot(top_n, aes(x=hastatus, y=ihpamount)) +
                geom_col() +
                coord_flip() +
                labs(title = 'IHP Amount',
                     x = 'HA status',
                     y = 'IHP amount')


# HA eligible - reorder and select top 10
d_hastatus$hastatus <- factor(d_hastatus$hastatus, levels = d_hastatus$hastatus[order(d_hastatus$haeligible)])
top_n <- head(d_hastatus[order(haeligible, decreasing = TRUE)], 10)

ggplot(top_n, aes(x=hastatus, y=haeligible)) +
                geom_col() +
                coord_flip() +
                labs(title = 'HA Eligible',
                     x = 'HA status',
                     y = 'HA eligible ($)')

# HA amount - reorder and select top 10
d_hastatus$hastatus <- factor(d_hastatus$hastatus, levels = d_hastatus$hastatus[order(d_hastatus$haamount)])
top_n <- head(d_hastatus[order(haamount, decreasing = TRUE)], 10)

ggplot(top_n, aes(x=hastatus, y=haamount)) +
                geom_col() +
                coord_flip() +
                labs(title = 'HA Amount',
                     x = 'HA status',
                     y = 'HA amount ($)')
```

**Which `hastatus` codes relate to which assistance program/funds?**

```{r, fig.width=8, fig.height=8}
# Correlation plot
res <- d_fema[ ,c('homedamage', 'destroyed', 'roofdamage', 'autodamage', 'emergencyneeds', 'foodneed',
                  'flooddamage', 'waterlevel', 'ihpamount', 'haamount', 'onaamount', 'personalpropertyamount',
                  'roofdamageamount', 'replacementamount','rpfvl', 'ppfvl')]

corr_p <- ggcorrplot(cor(res), lab = TRUE, type = 'lower',
  outline.col = 'white', ggtheme = theme_gray,
  colors = c('#6D9EC1', 'white', '#E46726')) +
  ggtitle('Correlations')

corr_p
```

```{r, fig.width=16, fig.height=4}
# Relevel factors
d$grossincome <- factor(d_fema$grossincome, levels = c('<$15,000', '$15,000-$30,000', '$30,001-$60,000',
                                                 '$60,001-$120,000', '$120,001-$175,000', '>$175,000'))

# Income boxplot
income_p <- ggplot(d_fema, aes(grossincome, ihpamount)) +
              geom_boxplot(aes(fill = grossincome)) + 
              labs(title = 'Income and IHP Amount',
                   x = 'Gross income', y = 'IHP amount')

# Residence boxplot
residence_p <- ggplot(d_fema, aes(residencetype, ihpamount)) +
                geom_boxplot(aes(fill = residencetype)) + 
                labs(title = 'Residence and IHP Amount',
                     x = 'Residence type', y = 'IHP amount')

# Arrange plots
grid.arrange(income_p, residence_p, ncol=2)
```


```{r}
# For those inspected, who had insurance?
(d_inspected <- d_fema[inspnreturned == 1, .(count = .N,
                                             homeownersinsurance = mean(homeownersinsurance),
                                             floodinsurance = mean(floodinsurance))])
```


```{r}
# Inspected but not insured
d_uninsured <- d_fema[(inspnreturned == 1 & (homeownersinsurance == 0 & floodinsurance == 0)),
                       c('inspnreturned', 'homeownersinsurance', 'floodinsurance')]

# Uniinsured summary
uninsured_agg <- d_uninsured[ , .(count = .N,
                                   inspnreturned = mean(inspnreturned),
                                   homeownersinsurance = mean(homeownersinsurance),
                                   floodinsurance = mean(floodinsurance))]

# Percentage without insurance that were inspected
paste0('Percentage without insurance that were inspected: ', round(100*uninsured_agg$count/d_inspected$count, 1), '%')
```

## Understanding Payment Amounts

```{r}
## Calculate total FEMA assistance received - DUPLICATE PAYMENTS CAPTURED!  
## Incude: ihpamount, haamount, onaamount, fipamount, flooddamageamount, foundationdamageamount, replacementamount, roofdamageamount
## Excluded: rentalassistanceamount 
# d_fema[ , `:=` (totalamount = ihpamount + haamount + onaamount + fipamount + flooddamageamount +
#                          foundationdamageamount + replacementamount + roofdamageamount,
#                 pendingneed = rpfvl - totalamount)]
# 
## HA status
# d_check1 <- d_fema[ , .(count = .N,
#                         totalamount = sum(totalamount),
#                         rpfvl = sum(rpfvl),
#                         pendingneed = sum(pendingneed)), keyby=county]
# 
# d_check1
```

```{r}
# Does IHP = HA + ONA?  Yes.
d[ , `:=` (totalamount = haamount + onaamount,
           check = totalamount - ihpamount)]

# HA status
d_check <- d_fema[ , .(count = .N,
                       ihpamount = sum(ihpamount),
                       haamount = sum(haamount),
                       onaamount = sum(onaamount),
                       check = sum(check)), keyby=county]

summary(d_check)
```

## FEMA Aggregated by County


```{r}
# Identify numeric variables
is_num <- unlist(lapply(d_fema, is.numeric))
head(data.frame(d_fema)[ , is_num])
```


```{r}
# Create pending need - check if IHP reflects all FEMA funds received?
d_fema[ , `:=` (pendingneed = rpfvl - ihpamount)]

# HA status
d_county <- d_fema[ , .(count = .N,
                        accessfunctionalneeds = sum(accessfunctionalneeds),
                        autodamage = sum(autodamage),
                        destroyed = sum(destroyed),
                        emergencyneeds = sum(emergencyneeds),
                        fipamount = sum(fipamount),
                        flooddamage = sum(flooddamage),
                        flooddamageamount = sum(flooddamageamount),
                        floodinsurance = sum(floodinsurance),
                        foodneed = sum(foodneed),
                        foundationdamage = sum(foundationdamage),
                        foundationdamageamount = sum(foundationdamageamount),
                        haamount = sum(haamount),
                        haeligible = sum(haeligible),
                        hamax = sum(hamax),
                        hareferral = sum(hareferral),
                        habitabilityrepairsrequired = sum(habitabilityrepairsrequired),
                        homedamage = sum(homedamage),
                        homeownersinsurance = sum(homeownersinsurance),
                        ihpamount = sum(ihpamount),
                        ihpeligible = sum(ihpeligible),
                        ihpmax = sum(ihpmax),
                        ihpreferral = sum(ihpreferral),
                        inspnissued = sum(inspnissued),
                        inspnreturned = sum(inspnreturned),
                        onaamount = sum(onaamount),
                        onaeligible = sum(onaeligible),
                        onamax = sum(onamax),
                        onareferral = sum(onareferral),
                        personalpropertyamount = sum(personalpropertyamount),
                        ppfvl = sum(ppfvl),
                        primaryresidence = sum(primaryresidence),
                        rentalassistanceamount = sum(rentalassistanceamount),
                        rentalassistanceeligible = sum(rentalassistanceeligible),
                        repairamount = sum(repairamount),
                        repairassistanceeligible = sum(repairassistanceeligible),
                        replacementamount = sum(replacementamount),
                        replacementassistanceeligible = sum(replacementassistanceeligible),
                        roofdamage = sum(roofdamage),
                        roofdamageamount = sum(roofdamageamount),
                        rpfvl = sum(rpfvl),
                        sbaapproved = sum(sbaapproved),
                        sbaeligible = sum(sbaeligible),
                        tsacheckedin = sum(tsacheckedin),
                        tsaeligible = sum(tsaeligible),
                        utilitiesout = sum(utilitiesout),
                        waterlevel = sum(waterlevel),
                        pendingneed = sum(pendingneed)), keyby = county]

head(d_county)
```

```{r}
# Read in county data
d_lookup <- fread(file = '../data/census-county/county-fips-lookup.csv', encoding = 'UTF-8')
d_demographics <- fread(file = '../data/census-county/county-demographics.csv', encoding = 'UTF-8')

# Left join data
d_full <- merge(x = d_county, y = d_lookup, by = 'county', all.x = TRUE)
d_full <- merge(x = d_full, y = d_demographics, by = 'county_name', all.x = TRUE)

# Rename variables and tidy data
d_full <- d_full[county_name != 'Statewide', !c('fips_code.y')]
setnames(d_full, old = 'fips_code.x', new = 'fips_code')

# Reorder columns
d_full <- d_full %>%
  select(fips_code, everything())

head(d_full)
```

```{r}
# Calculate per capita and means
d_full <- d_full[ , `:=` (ihpamount_capita = ihpamount/pop_estimates_2019,
                             haamount_capita = haamount/pop_estimates_2019,
                             onaamount_capita = onaamount/pop_estimates_2019,
                             rpfvl_capita = rpfvl/pop_estimates_2019,
                             ppfvl_capita = ppfvl/pop_estimates_2019,
                             pendingneed_capita = pendingneed/pop_estimates_2019,
                             ihpeligible_capita = ihpeligible/pop_estimates_2019,
                             haeligible_capita = haeligible/pop_estimates_2019,
                             onaeligible_capita = onaeligible/pop_estimates_2019,
                             inspnreturned_capita = inspnreturned/pop_estimates_2019,
                             roofdamage_capita = roofdamage/pop_estimates_2019,
                             roofdamageamount_capita = roofdamageamount/pop_estimates_2019,
                             waterlevel_mean = waterlevel/pop_estimates_2019)]

## Write to csv
#fwrite(d_full, file = '../data/FEMA-IHP-county.csv')
```


```{r, message=FALSE}
# IHP amount and rpfvl summed
ggplot(d_full, aes(ihpamount, rpfvl, size = pop_estimates_2019)) +
  geom_point(alpha = 0.6) +
  geom_abline(color = 'blue') +
  labs(title = 'Pending Need - IHP and rpfvl',
       x = 'IHP amount ($)',
       y = 'Real property damages ($)')

# IHP amount and rpfvl per capita
ggplot(d_full, aes(ihpamount_capita, rpfvl_capita, size = pop_estimates_2019)) +
  geom_point(alpha = 0.6) +
  geom_abline(color = 'blue') +
  labs(title = 'Pending Need - IHP and rpfvl',
       x = 'IHP amount per capita ($)',
       y = 'Real property damages per capita ($)')

# Pending need and IHP amount
ggplot(d_full, aes(ihpamount_capita, pendingneed_capita, size = pop_estimates_2019)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = 'dashed', color = 'blue') +
  labs(title = 'Pending Need with IHP',
       x = 'IHP amount per capita ($)',
       y = 'Pending need per capita ($)')
```

```{r}
# Pending need and poverty
ggplot(d_full, aes(poverty_percent, pendingneed_capita, size = pop_estimates_2019)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = lm,  formula = y~x, color = 'blue') +
  labs(title = 'Pending Need with IHP',
       x = 'Poverty (%)',
       y = 'Pending need per capita ($)')

# Pending need and median income
ggplot(d_full, aes(median_household_income, pendingneed_capita, size = pop_estimates_2019)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = lm,  formula = y~x, color = 'blue') +
  labs(title = 'Pending Need with Income',
       x = 'Household income ($)',
       y = 'Pending need per capita ($)')

# Pending need and roof damaged
ggplot(d_full, aes(roofdamage_capita, pendingneed_capita, size = pop_estimates_2019)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = lm,  formula = y~x, color = 'blue') +
  labs(title = 'Pending Need with Income',
       x = 'Roof damaged',
       y = 'Pending need per capita ($)')
```


```{r}
#inspnIssued
#scatter plot ihp amount rvpfl
#mean ihp rvpfl gap
#mean ihp amount by city
#declaration date
```



